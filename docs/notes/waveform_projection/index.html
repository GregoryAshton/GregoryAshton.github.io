<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Gregory Ashton">
    <link rel="canonical" href="https://www.GregoryAshton.github.io/notes/waveform_projection/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
    <title>Waveform projection - Gregory Ashton</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="../..">Gregory Ashton</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../science/">Science</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../group/">Group</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../projects/">Projects</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../help/">Help</a>
                    </li>
                
                
                
                    <li >
                        <a href="../">Notes</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/GregoryAshton/GregoryAshton.github.io/edit/master/docs/notes/waveform_projection.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#generating-time-domain-waveforms-and-projecting-them-onto-the-detectors">Generating time domain waveforms and projecting them onto the detectors</a></li>
            <li class="second-level"><a href="#setting-a-few-things-up">Setting a few things up</a></li>
                
            <li class="second-level"><a href="#generate-a-waveform">Generate a waveform</a></li>
                
            <li class="second-level"><a href="#extract-the-data">Extract the data</a></li>
                
            <li class="second-level"><a href="#project-onto-the-hanford-interferometer">Project onto the Hanford interferometer</a></li>
                
            <li class="second-level"><a href="#plot-the-data">Plot the data</a></li>
                
            <li class="second-level"><a href="#interpolate-onto-a-sampled-data-grid">Interpolate onto a sampled data grid</a></li>
                
            <li class="second-level"><a href="#putting-it-all-together-into-a-single-function">Putting it all together into a single function</a></li>
                
            <li class="second-level"><a href="#time-the-generation">Time the generation</a></li>
                
            <li class="second-level"><a href="#profile-the-generation">Profile the generation</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<div class="highlight"><pre><span></span><code><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">bilby</span> <span class="n">lalsuite</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">lalsimulation</span> <span class="k">as</span> <span class="nn">lalsim</span>
<span class="kn">import</span> <span class="nn">lal</span>
<span class="kn">import</span> <span class="nn">bilby</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">solar_mass</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">solar_mass</span>
<span class="n">parsec</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">parsec</span>
</code></pre></div>
<h1 id="generating-time-domain-waveforms-and-projecting-them-onto-the-detectors">Generating time domain waveforms and projecting them onto the detectors</h1>
<p>In this notebook, I'll demonstrate how to use <code>lalsimulation</code> to generate a time-domain waveform and how to then use <code>bilby</code> to calculate the response of an interferometer.</p>
<h2 id="setting-a-few-things-up">Setting a few things up</h2>
<p>To get started, let's define some properties of the data we want to simulate. This is the sampling frequency, duration and the amount of time before and after the trigger time (roughly speaking, the peak of the 2,2 mode).</p>
<div class="highlight"><pre><span></span><code><span class="n">sampling_frequency</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">deltaT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sampling_frequency</span>
<span class="n">duration</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">post_trigger_duration</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">pre_trigger_duration</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="n">post_trigger_duration</span>
</code></pre></div>
<h2 id="generate-a-waveform">Generate a waveform</h2>
<p>Now, we'll use <code>lalsim.SimInspiralChooseTDWaveform</code> to generate the plus and cross polarization</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Define the parameters in SI units</span>
<span class="n">mass_1</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">solar_mass</span>
<span class="n">mass_2</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">solar_mass</span>
<span class="n">spin_1x</span><span class="p">,</span> <span class="n">spin_1y</span><span class="p">,</span> <span class="n">spin_1z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">spin_2x</span><span class="p">,</span> <span class="n">spin_2y</span><span class="p">,</span> <span class="n">spin_2z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">luminosity_distance</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">theta_jn</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">longAscNodes</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">eccentricity</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">meanPerAno</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">LALParams</span> <span class="o">=</span> <span class="n">lal</span><span class="o">.</span><span class="n">CreateDict</span><span class="p">()</span>

<span class="c1"># Get the approximant number from the name</span>
<span class="n">waveform_approximant</span> <span class="o">=</span> <span class="s2">&quot;IMRPhenomT&quot;</span>
<span class="n">approximant</span> <span class="o">=</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">GetApproximantFromString</span><span class="p">(</span><span class="n">waveform_approximant</span><span class="p">)</span>

<span class="c1"># Estimate a minimum frequency required to ensure the waveform covers the data</span>
<span class="c1"># Note the 0.95 is a fudge factor as SimInspiralChirpStartFrequencyBound includes</span>
<span class="c1"># only the leading order Newtonian coefficient.</span>
<span class="n">f_min</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralChirpStartFrequencyBound</span><span class="p">(</span><span class="n">pre_trigger_duration</span><span class="p">,</span> <span class="n">mass_1</span><span class="p">,</span> <span class="n">mass_2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralGetSpinFreqFromApproximant</span><span class="p">(</span><span class="n">approximant</span><span class="p">)</span> <span class="o">==</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SIM_INSPIRAL_SPINS_FLOW</span><span class="p">:</span>
    <span class="n">f_ref</span> <span class="o">=</span> <span class="n">f_min</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">f_ref</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">h_plus_timeseries</span><span class="p">,</span> <span class="n">h_cross_timeseries</span> <span class="o">=</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralChooseTDWaveform</span><span class="p">(</span>
    <span class="n">mass_1</span><span class="p">,</span> <span class="n">mass_2</span><span class="p">,</span> <span class="n">spin_1x</span><span class="p">,</span> <span class="n">spin_1y</span><span class="p">,</span> <span class="n">spin_1z</span><span class="p">,</span> <span class="n">spin_2x</span><span class="p">,</span> <span class="n">spin_2y</span><span class="p">,</span> <span class="n">spin_2z</span><span class="p">,</span> <span class="n">luminosity_distance</span><span class="p">,</span> <span class="n">theta_jn</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> 
    <span class="n">longAscNodes</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">,</span> <span class="n">meanPerAno</span><span class="p">,</span> <span class="n">deltaT</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">f_ref</span><span class="p">,</span> <span class="n">LALParams</span><span class="p">,</span>
    <span class="n">approximant</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="extract-the-data">Extract the data</h2>
<div class="highlight"><pre><span></span><code><span class="n">h_plus</span> <span class="o">=</span> <span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
<span class="n">h_cross</span> <span class="o">=</span> <span class="n">h_cross_timeseries</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
<span class="n">h_plus_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_plus</span><span class="p">))</span> <span class="o">*</span> <span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">deltaT</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
<span class="n">h_cross_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_cross</span><span class="p">))</span> <span class="o">*</span> <span class="n">h_cross_timeseries</span><span class="o">.</span><span class="n">deltaT</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">h_cross_timeseries</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div>
<h2 id="project-onto-the-hanford-interferometer">Project onto the Hanford interferometer</h2>
<div class="highlight"><pre><span></span><code><span class="n">ra</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">dec</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.1</span>
<span class="n">geocent_time</span> <span class="o">=</span> <span class="mf">1126259462.1</span>
<span class="n">psi</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">H1</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">get_empty_interferometer</span><span class="p">(</span><span class="s2">&quot;H1&quot;</span><span class="p">)</span>

<span class="n">plus_polarization_tensor</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_polarization_tensor</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s2">&quot;plus&quot;</span><span class="p">)</span>
<span class="n">f_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;&#39;</span><span class="p">,</span> <span class="n">H1</span><span class="o">.</span><span class="n">detector_tensor</span><span class="p">,</span> <span class="n">plus_polarization_tensor</span><span class="p">)</span>

<span class="n">cross_polarization_tensor</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_polarization_tensor</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">)</span>
<span class="n">f_cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;&#39;</span><span class="p">,</span> <span class="n">H1</span><span class="o">.</span><span class="n">detector_tensor</span><span class="p">,</span> <span class="n">cross_polarization_tensor</span><span class="p">)</span>

<span class="n">strain</span> <span class="o">=</span> <span class="n">f_plus</span> <span class="o">*</span> <span class="n">h_plus</span> <span class="o">+</span> <span class="n">f_cross</span> <span class="o">*</span> <span class="n">h_cross</span>
<span class="n">strain_time</span> <span class="o">=</span> <span class="n">h_plus_time</span>
</code></pre></div>
<h2 id="plot-the-data">Plot the data</h2>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strain_time</span><span class="p">,</span> <span class="n">strain</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Strain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPS time [s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../waveform_projection_files/waveform_projection_11_0.png" /></p>
<p>From the plot above (or by inspecting <code>strain</code> and <code>strain_time</code>), we see that <code>SimInspiralChooseTDWaveform</code> outputs the strain on a grid of times with sampling frequency <code>1/deltaT</code>, but that the duration is determined by <code>f_min</code> and that peak of the 2,2 mode occurs at <code>0</code>.</p>
<p>We can translate this to the time measured by a detector by simply adding <code>geocent_time</code>, e.g.</p>
<div class="highlight"><pre><span></span><code><span class="n">strain_detector_time</span> <span class="o">=</span> <span class="n">strain_time</span> <span class="o">+</span> <span class="n">geocent_time</span>
</code></pre></div>
<p>But, we'll want to compare our predicted strain with a timeseries of detector data which will be sampled on a different grid (even if the sampling frequency is identical, we would not expect a sampled timeseries to align with the peak of the 2,2 mode!). To convert, we can interpolate.</p>
<h2 id="interpolate-onto-a-sampled-data-grid">Interpolate onto a sampled data grid</h2>
<div class="highlight"><pre><span></span><code><span class="n">n</span> <span class="o">=</span> <span class="n">sampling_frequency</span> <span class="o">*</span> <span class="n">duration</span>
<span class="n">data_start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geocent_time</span><span class="p">)</span> <span class="o">-</span> <span class="n">pre_trigger_duration</span>
<span class="n">data_detector_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">sampling_frequency</span> <span class="o">+</span> <span class="n">data_start_time</span> 
<span class="n">h_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">strain_detector_time</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">data_detector_time</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_detector_time</span> <span class="o">-</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">h_interp</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strain_detector_time</span> <span class="o">-</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Strain&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPS time - </span><span class="si">{</span><span class="n">geocent_time</span><span class="si">}</span><span class="s2"> [s]&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_detector_time</span> <span class="o">-</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">h_interp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Interpolated&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strain_detector_time</span> <span class="o">-</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Strain&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Strain&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPS time - </span><span class="si">{</span><span class="n">geocent_time</span><span class="si">}</span><span class="s2"> [s]&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../waveform_projection_files/waveform_projection_17_0.png" /></p>
<h2 id="putting-it-all-together-into-a-single-function">Putting it all together into a single function</h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bilby.gw.utils</span> <span class="kn">import</span> <span class="n">_get_lalsim_approximant</span><span class="p">,</span> <span class="n">convert_args_list_to_float</span>

<span class="k">def</span> <span class="nf">get_gw_waveform</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">waveform_approximant</span><span class="p">,</span> <span class="n">reference_frequency</span><span class="p">,</span> <span class="n">bilby_detector</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">reference_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pre_trigger_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">par</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">convert_to_lal_binary_black_hole_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="n">mass_1_SI</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;mass_1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">solar_mass</span>
    <span class="n">mass_2_SI</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;mass_2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">solar_mass</span>
    <span class="n">luminosity_distance_SI</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;luminosity_distance&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">parsec</span>

    <span class="c1"># Extract information about the time series</span>
    <span class="n">deltaT</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pre_trigger_duration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nearest_trigger_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">]))</span>
        <span class="n">pre_trigger_duration</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">nearest_trigger_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get the approximant number from the name</span>
    <span class="n">approximant</span> <span class="o">=</span> <span class="n">_get_lalsim_approximant</span><span class="p">(</span><span class="n">waveform_approximant</span><span class="p">)</span>

    <span class="c1"># Estimate a minimum frequency required to ensure the waveform covers the data</span>
    <span class="c1"># Note the 0.95 is a fudge factor as SimInspiralChirpStartFrequencyBound includes</span>
    <span class="c1"># only the leading order Newtonian coefficient.</span>
    <span class="n">f_min</span> <span class="o">=</span> <span class="n">fudge</span> <span class="o">*</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralChirpStartFrequencyBound</span><span class="p">(</span>
        <span class="n">pre_trigger_duration</span><span class="p">,</span> 
        <span class="n">mass_1_SI</span><span class="p">,</span>
        <span class="n">mass_2_SI</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check if the reference frequency is used, if not use f_min</span>
    <span class="k">if</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralGetSpinFreqFromApproximant</span><span class="p">(</span><span class="n">approximant</span><span class="p">)</span> <span class="o">==</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SIM_INSPIRAL_SPINS_FLOW</span><span class="p">:</span>
        <span class="n">f_ref</span> <span class="o">=</span> <span class="n">f_min</span>
    <span class="k">elif</span> <span class="n">reference_frequency</span> <span class="o">==</span> <span class="s2">&quot;fmin&quot;</span><span class="p">:</span>
        <span class="n">f_ref</span> <span class="o">=</span> <span class="n">f_min</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f_ref</span> <span class="o">=</span> <span class="n">reference_frequency</span>

    <span class="n">iota</span><span class="p">,</span> <span class="n">spin_1x</span><span class="p">,</span> <span class="n">spin_1y</span><span class="p">,</span> <span class="n">spin_1z</span><span class="p">,</span> <span class="n">spin_2x</span><span class="p">,</span> <span class="n">spin_2y</span><span class="p">,</span> <span class="n">spin_2z</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">bilby_to_lalsimulation_spins</span><span class="p">(</span>
        <span class="n">theta_jn</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;theta_jn&quot;</span><span class="p">],</span> <span class="n">phi_jl</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;phi_jl&quot;</span><span class="p">],</span> <span class="n">tilt_1</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;tilt_1&quot;</span><span class="p">],</span> <span class="n">tilt_2</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;tilt_2&quot;</span><span class="p">],</span>
        <span class="n">phi_12</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;phi_12&quot;</span><span class="p">],</span> <span class="n">a_1</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;a_1&quot;</span><span class="p">],</span> <span class="n">a_2</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;a_2&quot;</span><span class="p">],</span> <span class="n">mass_1</span><span class="o">=</span><span class="n">mass_1_SI</span><span class="p">,</span> <span class="n">mass_2</span><span class="o">=</span><span class="n">mass_2_SI</span><span class="p">,</span>
        <span class="n">reference_frequency</span><span class="o">=</span><span class="n">f_ref</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;zenith&quot;</span> <span class="ow">in</span> <span class="n">par</span> <span class="ow">and</span> <span class="s2">&quot;azimuth&quot;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">:</span>
        <span class="n">par</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">zenith_azimuth_to_ra_dec</span><span class="p">(</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">],</span> <span class="n">reference_frame</span><span class="p">)</span>

    <span class="n">longitude_ascending_nodes</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">eccentricity</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">mean_per_ano</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">waveform_dictionary</span> <span class="o">=</span> <span class="n">lal</span><span class="o">.</span><span class="n">CreateDict</span><span class="p">()</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">convert_args_list_to_float</span><span class="p">(</span>
        <span class="n">mass_1_SI</span><span class="p">,</span> <span class="n">mass_2_SI</span><span class="p">,</span>
        <span class="n">spin_1x</span><span class="p">,</span> <span class="n">spin_1y</span><span class="p">,</span> <span class="n">spin_1z</span><span class="p">,</span>
        <span class="n">spin_2x</span><span class="p">,</span> <span class="n">spin_2y</span><span class="p">,</span> <span class="n">spin_2z</span><span class="p">,</span>
        <span class="n">luminosity_distance_SI</span><span class="p">,</span> <span class="n">iota</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span>
        <span class="n">longitude_ascending_nodes</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">,</span> <span class="n">mean_per_ano</span><span class="p">,</span>
        <span class="n">deltaT</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">f_ref</span><span class="p">)</span>

    <span class="n">h_plus_timeseries</span><span class="p">,</span> <span class="n">h_cross_timeseries</span> <span class="o">=</span> <span class="n">lalsim</span><span class="o">.</span><span class="n">SimInspiralChooseTDWaveform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">waveform_dictionary</span><span class="p">,</span> <span class="n">approximant</span>   
    <span class="p">)</span>

    <span class="n">plus_polarization_tensor</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_polarization_tensor</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;psi&quot;</span><span class="p">],</span> <span class="s2">&quot;plus&quot;</span><span class="p">)</span>
    <span class="n">f_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;&#39;</span><span class="p">,</span> <span class="n">bilby_detector</span><span class="o">.</span><span class="n">detector_tensor</span><span class="p">,</span> <span class="n">plus_polarization_tensor</span><span class="p">)</span>

    <span class="n">cross_polarization_tensor</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_polarization_tensor</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;psi&quot;</span><span class="p">],</span> <span class="s2">&quot;cross&quot;</span><span class="p">)</span>
    <span class="n">f_cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;&#39;</span><span class="p">,</span> <span class="n">bilby_detector</span><span class="o">.</span><span class="n">detector_tensor</span><span class="p">,</span> <span class="n">cross_polarization_tensor</span><span class="p">)</span>

    <span class="n">h_plus</span> <span class="o">=</span> <span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
    <span class="n">h_cross</span> <span class="o">=</span> <span class="n">h_cross_timeseries</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
    <span class="n">h_plus_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_plus</span><span class="p">))</span> <span class="o">*</span> <span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">deltaT</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">h_plus_timeseries</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">f_plus</span> <span class="o">*</span> <span class="n">h_plus</span> <span class="o">+</span> <span class="n">f_cross</span> <span class="o">*</span> <span class="n">h_cross</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">h_plus_time</span> <span class="o">+</span> <span class="n">par</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">]</span>

    <span class="n">h_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">h_interp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Generated waveform was too short&quot;</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_interp</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">mass_1</span><span class="o">=</span><span class="mf">36.</span><span class="p">,</span> <span class="n">mass_2</span><span class="o">=</span><span class="mf">29.</span><span class="p">,</span> <span class="n">chi_1</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">chi_2</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">luminosity_distance</span><span class="o">=</span><span class="mf">2000.</span><span class="p">,</span> <span class="n">theta_jn</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mf">2.659</span><span class="p">,</span>
    <span class="n">phase</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">geocent_time</span><span class="o">=</span><span class="n">geocent_time</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="mf">1.375</span><span class="p">,</span> <span class="n">dec</span><span class="o">=-</span><span class="mf">1.2108</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;IMRPhenomT&quot;</span><span class="p">,</span> <span class="s2">&quot;SEOBNRv4T&quot;</span><span class="p">,</span> <span class="s2">&quot;TEOBResumS&quot;</span><span class="p">]:</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">waveform</span><span class="p">,</span> <span class="s2">&quot;fmin&quot;</span><span class="p">,</span> <span class="n">H1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_detector_time</span> <span class="o">-</span> <span class="n">geocent_time</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">waveform</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Strain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPS time - </span><span class="si">{</span><span class="n">geocent_time</span><span class="si">}</span><span class="s2"> [s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../waveform_projection_files/waveform_projection_20_0.png" /></p>
<h2 id="time-the-generation">Time the generation</h2>
<div class="highlight"><pre><span></span><code><span class="n">prior</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">BBHPriorDict</span><span class="p">()</span>
<span class="n">prior</span><span class="p">[</span><span class="s2">&quot;geocent_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">geocent_time</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">geocent_time</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>10:29 bilby INFO    : No prior given, using default BBH priors in /home/greg/bilby/bilby/gw/prior_files/precessing_spins_bbh.prior.
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span> <span class="s2">&quot;SEOBNRv4P&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>1.28 s ± 96.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span> <span class="s2">&quot;IMRPhenomTP&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>30.9 ms ± 2.82 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span> <span class="s2">&quot;IMRPhenomPv2&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pre_trigger_duration</span><span class="o">=</span><span class="n">pre_trigger_duration</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>13.6 ms ± 237 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</code></pre></div>
<h2 id="profile-the-generation">Profile the generation</h2>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">line_profiler</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">T</span> <span class="n">profile</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">u</span> <span class="mf">1e-3</span> <span class="o">-</span><span class="n">f</span> <span class="n">get_gw_waveform</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span> <span class="s2">&quot;IMRPhenomTP&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>*** Profile printout saved to text file &#39;profile.txt&#39;.
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="err">!</span><span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">15</span> <span class="n">profile</span><span class="o">.</span><span class="n">txt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Timer unit: 0.001 s

Total time: 0.029128 s
File: /tmp/ipykernel_1170/3049955836.py
Function: get_gw_waveform at line 3

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     3                                           def get_gw_waveform(time, parameters, waveform_approximant, reference_frequency, bilby_detector, fudge=0.95, reference_frame=None, pre_trigger_duration=None, error=False):
     4         1          0.1      0.1      0.2      par, _ = bilby.gw.conversion.convert_to_lal_binary_black_hole_parameters(parameters)
     5                                                   
     6         1          0.0      0.0      0.0      mass_1_SI = par[&quot;mass_1&quot;] * solar_mass
     7         1          0.0      0.0      0.0      mass_2_SI = par[&quot;mass_2&quot;] * solar_mass
     8         1          0.0      0.0      0.0      luminosity_distance_SI = par[&quot;luminosity_distance&quot;] * 1e6 * parsec
     9
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="err">!</span><span class="n">tail</span> <span class="o">-</span><span class="n">n</span> <span class="o">+</span><span class="mi">9</span> <span class="n">profile</span><span class="o">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">-</span><span class="n">k</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    60         4         27.6      6.9     94.7      h_plus_timeseries, h_cross_timeseries = lalsim.SimInspiralChooseTDWaveform(
    77         1          0.6      0.6      2.0      h_interp = interp1d(t, h, fill_value=0, bounds_error=False)(time)
    64         1          0.3      0.3      0.9      plus_polarization_tensor = bilby.gw.utils.get_polarization_tensor(par[&quot;ra&quot;], par[&quot;dec&quot;], par[&quot;geocent_time&quot;], par[&quot;psi&quot;], &quot;plus&quot;)
    38         2          0.2      0.1      0.7      iota, spin_1x, spin_1y, spin_1z, spin_2x, spin_2y, spin_2z = bilby.gw.conversion.bilby_to_lalsimulation_spins(
    74         1          0.1      0.1      0.3      h = f_plus * h_plus + f_cross * h_cross
    72         1          0.1      0.1      0.3      h_plus_time = np.arange(len(h_plus)) * h_plus_timeseries.deltaT + float(h_plus_timeseries.epoch)
    67         1          0.1      0.1      0.2      cross_polarization_tensor = bilby.gw.utils.get_polarization_tensor(par[&quot;ra&quot;], par[&quot;dec&quot;], par[&quot;geocent_time&quot;], par[&quot;psi&quot;], &quot;cross&quot;)
    13         1          0.1      0.1      0.4          nearest_trigger_idx = np.argmin(np.abs(time - par[&quot;geocent_time&quot;]))
     4         1          0.1      0.1      0.2      par, _ = bilby.gw.conversion.convert_to_lal_binary_black_hole_parameters(parameters)
    85         1          0.0      0.0      0.0      return h_interp
</code></pre></div>
<p>We can remove that lookup for the <code>pre_trigger_duration</code> if we know it</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">T</span> <span class="n">profile</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">u</span> <span class="mf">1e-3</span> <span class="o">-</span><span class="n">f</span> <span class="n">get_gw_waveform</span> <span class="n">get_gw_waveform</span><span class="p">(</span><span class="n">data_detector_time</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span> <span class="s2">&quot;IMRPhenomTP&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">pre_trigger_duration</span><span class="o">=</span><span class="n">pre_trigger_duration</span><span class="p">)</span>
<span class="err">!</span><span class="n">tail</span> <span class="o">-</span><span class="n">n</span> <span class="o">+</span><span class="mi">9</span> <span class="n">profile</span><span class="o">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">-</span><span class="n">k</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>*** Profile printout saved to text file &#39;profile.txt&#39;. 
    60         4         38.3      9.6     91.5      h_plus_timeseries, h_cross_timeseries = lalsim.SimInspiralChooseTDWaveform(
    77         1          1.5      1.5      3.7      h_interp = interp1d(t, h, fill_value=0, bounds_error=False)(time)
    74         1          0.8      0.8      2.0      h = f_plus * h_plus + f_cross * h_cross
    38         2          0.4      0.2      0.9      iota, spin_1x, spin_1y, spin_1z, spin_2x, spin_2y, spin_2z = bilby.gw.conversion.bilby_to_lalsimulation_spins(
    64         1          0.2      0.2      0.6      plus_polarization_tensor = bilby.gw.utils.get_polarization_tensor(par[&quot;ra&quot;], par[&quot;dec&quot;], par[&quot;geocent_time&quot;], par[&quot;psi&quot;], &quot;plus&quot;)
     4         1          0.2      0.2      0.4      par, _ = bilby.gw.conversion.convert_to_lal_binary_black_hole_parameters(parameters)
    75         1          0.1      0.1      0.1      t = h_plus_time + par[&quot;geocent_time&quot;]
    72         1          0.1      0.1      0.3      h_plus_time = np.arange(len(h_plus)) * h_plus_timeseries.deltaT + float(h_plus_timeseries.epoch)
    85         1          0.0      0.0      0.0      return h_interp
    84                                                       print(msg)
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
